<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KPI Dashboard</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');

    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background: #001F3F; /* Deep Navy */
      color: #fff;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      user-select: none;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 30px 20px;
    }

    h1 {
      color: #FF6F00; /* Vivid Orange */
      font-weight: 700;
      font-size: 3rem;
      margin-bottom: 30px;
      text-shadow: 0 0 12px #FF6F00;
    }

    .filters {
      display: flex;
      gap: 20px;
      margin-bottom: 40px;
      flex-wrap: wrap;
      justify-content: center;
    }
    select {
      background: #014871;
      border: none;
      border-radius: 12px;
      padding: 12px 16px;
      font-weight: 600;
      font-size: 1rem;
      color: #FF4081; /* Bright Pink */
      box-shadow: 0 0 10px #FF6F00 inset;
      outline: none;
      cursor: pointer;
      transition: background 0.3s ease, color 0.3s ease;
      user-select: none;
      min-width: 140px;
    }
    select:hover, select:focus {
      background: #FF6F00;
      color: #001F3F;
      box-shadow: 0 0 20px #FF6F00;
    }

    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(220px,1fr));
      gap: 30px;
      width: 100%;
      max-width: 900px;
      margin-bottom: 50px;
    }
    .card {
      background: #012548;
      border-radius: 20px;
      padding: 30px 25px;
      box-shadow:
        0 0 30px #FF6F00,
        inset 0 0 40px 10px #FF6F00;
      animation: glowingShadow 4s ease-in-out infinite alternate;
      display: flex;
      flex-direction: column;
      align-items: center;
      color: #FF6F00;
      font-weight: 700;
      font-size: 1.5rem;
      user-select: none;
      position: relative;
      text-align: center;
      transition: box-shadow 0.3s ease;
    }
    .card:hover {
      box-shadow:
        0 0 50px #FF8F00,
        inset 0 0 55px 20px #FF8F00;
      color: #FFA726;
      cursor: default;
    }
    .card .label {
      font-size: 1rem;
      color: #FF4081; /* Bright Pink */
      margin-bottom: 10px;
      letter-spacing: 0.07em;
      text-transform: uppercase;
    }
    .card .value {
      font-size: 2.8rem;
      font-weight: 900;
      color: #FF6F00;
      text-shadow: 0 0 15px #FF6F00;
    }

    @keyframes glowingShadow {
      0% {
        box-shadow:
          0 0 25px #FF6F00,
          inset 0 0 40px 10px #FF6F00;
      }
      100% {
        box-shadow:
          0 0 45px #FF6F00,
          inset 0 0 55px 20px #FF6F00;
      }
    }

    canvas {
      max-width: 900px;
      background: #012548;
      border-radius: 20px;
      padding: 20px;
      box-shadow:
        0 0 30px #FF6F00,
        inset 0 0 40px 10px #FF6F00;
      user-select: none;
    }

    .charts {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 40px;
      width: 100%;
      max-width: 900px;
    }

    .chart-container {
      flex: 1 1 400px;
      max-width: 450px;
      user-select: none;
    }

    @media (max-width: 520px) {
      .cards {
        grid-template-columns: 1fr;
      }
      .charts {
        flex-direction: column;
        gap: 30px;
      }
    }
  </style>
</head>
<body>

  <h1>Vivid Orange KPI Dashboard</h1>

  <div class="filters" role="region" aria-label="Filter by Month and Year">
    <select id="monthSelect" aria-label="Select Month">
      <option value="all">All Months</option>
      <option value="1">January</option>
      <option value="2">February</option>
      <option value="3">March</option>
      <option value="4">April</option>
      <option value="5">May</option>
      <option value="6">June</option>
      <option value="7">July</option>
      <option value="8">August</option>
      <option value="9">September</option>
      <option value="10">October</option>
      <option value="11">November</option>
      <option value="12">December</option>
    </select>

    <select id="yearSelect" aria-label="Select Year">
      <!-- Filled dynamically -->
    </select>
  </div>

  <section class="cards" aria-label="Key Performance Indicators">
    <article class="card" id="totalEarningsCard" tabindex="0" aria-live="polite" aria-atomic="true">
      <div class="label">Total Earnings (₹)</div>
      <div class="value" id="totalEarningsValue">0</div>
    </article>

    <article class="card" id="totalTasksCard" tabindex="0" aria-live="polite" aria-atomic="true">
      <div class="label">Total Tasks</div>
      <div class="value" id="totalTasksValue">0</div>
    </article>

    <article class="card" id="pendingTasksCard" tabindex="0" aria-live="polite" aria-atomic="true">
      <div class="label">Pending Tasks</div>
      <div class="value" id="pendingTasksValue">0</div>
    </article>

    <article class="card" id="completionRateCard" tabindex="0" aria-live="polite" aria-atomic="true">
      <div class="label">Completion Rate (%)</div>
      <div class="value" id="completionRateValue">0%</div>
    </article>
  </section>

  <div class="charts" aria-label="Charts Section">
    <div class="chart-container" role="img" aria-label="Pie chart showing pending and completed tasks">
      <canvas id="taskPieChart" aria-hidden="true"></canvas>
    </div>
    <div class="chart-container" role="img" aria-label="Bar chart showing monthly earnings">
      <canvas id="earningsBarChart" aria-hidden="true"></canvas>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBtv24xaZD2ZW-gxRsFnke087jCcL1LUTM",
      authDomain: "sudiptakpi-68c8f.firebaseapp.com",
      databaseURL: "https://sudiptakpi-68c8f-default-rtdb.firebaseio.com",
      projectId: "sudiptakpi-68c8f",
      storageBucket: "sudiptakpi-68c8f.firebasestorage.app",
      messagingSenderId: "543704606051",
      appId: "1:543704606051:web:6071848730da6e577e1f56",
      measurementId: "G-552VHS088R"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const recordsRef = ref(db, 'records');

    // Elements
    const totalEarningsEl = document.getElementById('totalEarningsValue');
    const totalTasksEl = document.getElementById('totalTasksValue');
    const pendingTasksEl = document.getElementById('pendingTasksValue');
    const completionRateEl = document.getElementById('completionRateValue');

    const monthSelect = document.getElementById('monthSelect');
    const yearSelect = document.getElementById('yearSelect');

    // Chart contexts
    const pieCtx = document.getElementById('taskPieChart').getContext('2d');
    const barCtx = document.getElementById('earningsBarChart').getContext('2d');

    // Initialize charts with empty data
    const taskPieChart = new Chart(pieCtx, {
      type: 'pie',
      data: {
        labels: ['Completed', 'Pending'],
        datasets: [{
          data: [0, 0],
          backgroundColor: ['#FF6F00', '#FF4081'],
          borderColor: '#001F3F',
          borderWidth: 2,
          hoverOffset: 20,
          hoverBorderColor: '#fff'
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'bottom', labels: {color: '#FF6F00', font: {weight:'700'}} }
        }
      }
    });

    const earningsBarChart = new Chart(barCtx, {
      type: 'bar',
      data: {
        labels: Array.from({length: 12}, (_, i) => new Date(0, i).toLocaleString('default', {month:'short'})),
        datasets: [{
          label: 'Earnings (₹)',
          data: new Array(12).fill(0),
          backgroundColor: '#FF6F00',
          borderRadius: 10,
          borderSkipped: false,
          hoverBackgroundColor: '#FFA726'
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
            ticks: { color: '#FF6F00', font: {weight:'700'} },
            grid: { color: '#014871' }
          },
          x: {
            ticks: { color: '#FF4081', font: {weight:'700'} },
            grid: { display: false }
          }
        },
        plugins: {
          legend: { display: false }
        }
      }
    });

    // Fill year dropdown with last 5 years + current year
    const currentYear = new Date().getFullYear();
    for(let y = currentYear; y >= currentYear - 5; y--) {
      const option = document.createElement('option');
      option.value = y;
      option.textContent = y;
      yearSelect.appendChild(option);
    }
    yearSelect.value = currentYear;

    function filterRecords(data) {
      const month = monthSelect.value;
      const year = yearSelect.value;

      return Object.values(data).filter(r => {
        const d = new Date(r.date + 'T00:00:00');
        if (year && d.getFullYear() != year) return false;
        if (month !== 'all' && (d.getMonth() + 1) != month) return false;
        return true;
      });
    }

    function updateDashboard(records) {
      const filtered = filterRecords(records);

      let totalEarnings = 0;
      let totalTasks = 0;
      let pendingTasks = 0;
      let completedTasks = 0;

      filtered.forEach(r => {
        if(r.type === 'earning') {
          totalEarnings += r.amount || 0;
        }
        if(r.type === 'task') {
          totalTasks++;
          if(r.status === 'pending') pendingTasks++;
          else if(r.status === 'completed') completedTasks++;
        }
      });

      const completionRate = totalTasks === 0 ? 0 : ((completedTasks / totalTasks) * 100).toFixed(1);

      // Update cards
      totalEarningsEl.textContent = totalEarnings.toLocaleString('en-IN', {style:'currency', currency:'INR', maximumFractionDigits:2});
      totalTasksEl.textContent = totalTasks;
      pendingTasksEl.textContent = pendingTasks;
      completionRateEl.textContent = completionRate + '%';

      // Update pie chart
      taskPieChart.data.datasets[0].data = [completedTasks, pendingTasks];
      taskPieChart.update();

      // Update earnings bar chart by month for selected year (ignore month filter for bar chart)
      const earningsByMonth = new Array(12).fill(0);
      Object.values(records).forEach(r => {
        if(r.type === 'earning') {
          const d = new Date(r.date + 'T00:00:00');
          if(year && d.getFullYear() == year) {
            earningsByMonth[d.getMonth()] += r.amount || 0;
          }
        }
      });
      earningsBarChart.data.datasets[0].data = earningsByMonth;
      earningsBarChart.update();
    }

    onValue(recordsRef, snapshot => {
      const data = snapshot.val() || {};
      updateDashboard(data);
    });

    monthSelect.addEventListener('change', () => {
      getDatabaseDataAndUpdate();
    });
    yearSelect.addEventListener('change', () => {
      getDatabaseDataAndUpdate();
    });

    // Helper to refetch and update dashboard
    function getDatabaseDataAndUpdate() {
      onValue(recordsRef, snapshot => {
        const data = snapshot.val() || {};
        updateDashboard(data);
      }, {onlyOnce:true});
    }
  </script>
</body>
</html>
